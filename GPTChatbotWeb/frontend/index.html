<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>GPT ì±—ë´‡ (íŒŒì¼Â·ìŒì„±Â·ì´ë¯¸ì§€ ì…ë ¥)</title>
  <style>
    body { font-family: Arial; padding: 2em; background: #f5f5f5; }
    #login, #chat { max-width: 700px; margin: auto; background: white; padding: 2em; border-radius: 10px; }
    #chat { display: none; }
    #chatbox { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; background: #fefefe; }
    input, select, button, textarea { width: 100%; padding: 0.7em; margin-top: 0.5em; }
    .msg { margin: 0.5em 0; }
    .user { font-weight: bold; color: #007bff; }
    .bot { font-weight: bold; color: #28a745; }
  </style>
</head>
<body>

<div id="login">
  <h2>ğŸ” GPT ì±—ë´‡ ë¡œê·¸ì¸</h2>
  <input id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" />
  <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (ê¸°ë³¸: 12345678)" />
  <button onclick="login()">ë¡œê·¸ì¸</button>
  <p id="loginStatus" style="color:red;"></p>
</div>

<div id="chat">
  <h3>ğŸ‘¤ <span id="displayName"></span>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</h3>
  <div id="chatbox"></div>
  <input id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
  <select id="model">
    <option value="gpt-4">GPT-4</option>
    <option value="gpt-3.5-turbo">GPT-3.5</option>
  </select>
  <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  <button onclick="regenerate()">â†º ë‹¤ì‹œ ìƒì„±</button>
  <button onclick="save()">ğŸ’¾ ì €ì¥</button>
  <hr />
  <h4>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ (PDF / TXT)</h4>
  <input type="file" id="fileUpload" accept=".pdf,.txt" />
  <textarea id="uploadResult" rows="4" readonly placeholder="ìš”ì•½ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
  <hr />
  <h4>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„¤ëª…)</h4>
  <input type="file" id="imageUpload" accept="image/*" />
  <textarea id="imageResult" rows="4" readonly placeholder="ì´ë¯¸ì§€ ì„¤ëª… ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
  <hr />
  <h4>ğŸ¤ ìŒì„± ì§ˆë¬¸</h4>
  <input type="file" id="voiceUpload" accept="audio/*" />
  <textarea id="voiceResult" rows="2" readonly placeholder="ìŒì„± ì¸ì‹ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
</div>

<script>
let session_id = "";
let history = [];

function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();

  fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
  .then(res => {
    if (!res.ok) throw new Error("Login failed");
    return res.json();
  })
  .then(data => {
    session_id = data.session_id;
    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
    document.getElementById("displayName").innerText = username;
  })
  .catch(() => {
    document.getElementById("loginStatus").innerText = "âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)";
  });
}

function appendMessage(role, content) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<span class="${role === 'user' ? 'user' : 'bot'}">${role === 'user' ? 'ğŸ‘¤ ë‚˜' : 'ğŸ¤– GPT'}:</span> ${content}`;
  document.getElementById("chatbox").appendChild(div);
  document.getElementById("chatbox").scrollTop = 99999;
}

function sendMessage() {
  const message = document.getElementById("message").value.trim();
  const model = document.getElementById("model").value;
  if (!message) return;

  appendMessage("user", message);
  document.getElementById("message").value = "";

  fetch('/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id, message, model })
  })
  .then(res => res.json())
  .then(data => {
    history = data.history;
    appendMessage("assistant", data.reply);
  });
}

function regenerate() {
  fetch('/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id, message: "[REPEAT_LAST]", model: document.getElementById("model").value })
  })
  .then(res => res.json())
  .then(data => {
    history = data.history;
    appendMessage("assistant", data.reply + " (ì¬ìƒì„±)");
  });
}

function save() {
  const blob = new Blob([JSON.stringify(history, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chat_history.json";
  a.click();
}

// ğŸ“ íŒŒì¼ ì—…ë¡œë“œ
document.getElementById("fileUpload").addEventListener("change", function () {
  const file = this.files[0];
  const form = new FormData();
  form.append("file", file);
  fetch("/upload", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => {
      document.getElementById("uploadResult").value = data.content;
    });
});

// ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ
document.getElementById("imageUpload").addEventListener("change", function () {
  const file = this.files[0];
  const form = new FormData();
  form.append("file", file);
  fetch("/image", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => {
      document.getElementById("imageResult").value = data.description;
    });
});

// ğŸ¤ ìŒì„± ì—…ë¡œë“œ
document.getElementById("voiceUpload").addEventListener("change", function () {
  const file = this.files[0];
  const form = new FormData();
  form.append("file", file);
  fetch("/voice", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => {
      document.getElementById("voiceResult").value = data.text;
    });
});
</script>

</body>
</html>
