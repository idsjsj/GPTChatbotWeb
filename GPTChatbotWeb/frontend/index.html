<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>GPT ì±—ë´‡ (3ë‹¨ê³„ ê´€ë¦¬ì + ë‹¤í¬ëª¨ë“œ)</title>
  <style>
    :root {
      --bg-light: #f5f5f5;
      --bg-dark: #121212;
      --text-light: #000;
      --text-dark: #eee;
      --chat-bg-light: #fff;
      --chat-bg-dark: #222;
      --user-color: #007bff;
      --bot-color: #28a745;
      --btn-bg: #007bff;
      --btn-color: #fff;
    }
    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    #login, #chat, #adminView {
      max-width: 700px;
      margin: 2em auto;
      padding: 2em;
      border-radius: 10px;
      background: var(--chat-bg-light);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    body.dark #login,
    body.dark #chat,
    body.dark #adminView {
      background: var(--chat-bg-dark);
      box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }
    #chat, #adminView {
      display: none;
    }
    #chatbox, #adminLog {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
      background: var(--chat-bg-light);
    }
    body.dark #chatbox, body.dark #adminLog {
      background: var(--chat-bg-dark);
      border-color: #555;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 0.7em;
      margin-top: 0.5em;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: inherit;
      color: inherit;
    }
    body.dark input, body.dark select, body.dark button, body.dark textarea {
      border-color: #555;
      background: #333;
      color: #eee;
    }
    button {
      background-color: var(--btn-bg);
      color: var(--btn-color);
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background-color: #888;
      cursor: default;
    }
    .msg {
      margin: 0.5em 0;
      white-space: pre-wrap;
    }
    .user {
      font-weight: bold;
      color: var(--user-color);
    }
    .bot {
      font-weight: bold;
      color: var(--bot-color);
    }
    #themeToggle {
      float: right;
      margin-top: -2.5em;
      margin-bottom: 1em;
      width: auto;
      padding: 0.4em 1em;
    }
    hr {
      margin: 2em 0;
      border: none;
      border-top: 1px solid #ccc;
    }
  </style>
</head>
<body class="light">

<div id="login">
  <h2>ğŸ” GPT ì±—ë´‡ ë¡œê·¸ì¸</h2>
  <input id="username" placeholder="ì‚¬ìš©ì ì´ë¦„ (ê´€ë¦¬ìëŠ” admin)" autocomplete="username" />
  <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (ê¸°ë³¸: 12345678)" autocomplete="current-password" />
  <button id="loginBtn" onclick="login()">ë¡œê·¸ì¸</button>
  <p id="loginStatus" style="color:red;"></p>
</div>

<div id="chat">
  <button id="themeToggle" onclick="toggleTheme()">ğŸŒ— ë‹¤í¬ëª¨ë“œ ì „í™˜</button>
  <h3>ğŸ‘¤ <span id="displayName"></span>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</h3>
  <div id="chatbox"></div>
  <input id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
  <select id="model">
    <option value="gpt-4">GPT-4</option>
    <option value="gpt-3.5-turbo">GPT-3.5</option>
  </select>
  <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  <button onclick="regenerate()">â†º ë‹¤ì‹œ ìƒì„±</button>
  <button onclick="save()">ğŸ’¾ ì €ì¥</button>

  <hr />
  <h4>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ (PDF / TXT)</h4>
  <input type="file" id="fileUpload" accept=".pdf,.txt" />
  <textarea id="uploadResult" rows="4" readonly placeholder="ìš”ì•½ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>

  <hr />
  <h4>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„¤ëª…)</h4>
  <input type="file" id="imageUpload" accept="image/*" />
  <textarea id="imageResult" rows="4" readonly placeholder="ì´ë¯¸ì§€ ì„¤ëª… ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>

  <hr />
  <h4>ğŸ¤ ìŒì„± ì§ˆë¬¸</h4>
  <input type="file" id="voiceUpload" accept="audio/*" />
  <textarea id="voiceResult" rows="2" readonly placeholder="ìŒì„± ì¸ì‹ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
</div>

<div id="adminView">
  <h2>ğŸ§‘â€ğŸ’¼ ê´€ë¦¬ì ëª¨ë“œ</h2>
  <button onclick="refreshAdmin()">ì „ì²´ ì„¸ì…˜ ëŒ€í™” ê¸°ë¡ ìƒˆë¡œê³ ì¹¨</button>
  <div id="adminLog" style="white-space: pre-wrap;"></div>
</div>

<script>
let session_id = "";
let is_admin = false;
let history = [];
const body = document.body;

function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  if (!username || !password) {
    document.getElementById("loginStatus").innerText = "ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
    return;
  }

  fetch('/login', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ username, password })
  })
  .then(res => {
    if (!res.ok) throw new Error("ë¡œê·¸ì¸ ì‹¤íŒ¨");
    return res.json();
  })
  .then(data => {
    session_id = data.session_id;
    is_admin = data.is_admin;
    document.getElementById("login").style.display = "none";
    if (is_admin) {
      document.getElementById("adminView").style.display = "block";
      refreshAdmin();
    } else {
      document.getElementById("chat").style.display = "block";
    }
    document.getElementById("displayName").innerText = username;
    document.getElementById("loginStatus").innerText = "";
    loadTheme();
  })
  .catch(() => {
    document.getElementById("loginStatus").innerText = "âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)";
  });
}

function appendMessage(role, content) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<span class="${role === 'user' ? 'user' : 'bot'}">${role === 'user' ? 'ğŸ‘¤ ë‚˜' : 'ğŸ¤– GPT'}:</span> ${content}`;
  document.getElementById("chatbox").appendChild(div);
  document.getElementById("chatbox").scrollTop = 99999;
}

function sendMessage() {
  const message = document.getElementById("message").value.trim();
  const model = document.getElementById("model").value;
  if (!message) return;

  appendMessage("user", message);
  document.getElementById("message").value = "";

  fetch('/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ session_id, message, model })
  })
  .then(res => res.json())
  .then(data => {
    history = data.history;
    appendMessage("assistant", data.reply);
  });
}

function regenerate() {
  fetch('/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ session_id, message: "[REPEAT_LAST]", model: document.getElementById("model").value })
  })
  .then(res => res.json())
  .then(data => {
    history = data.history;
    appendMessage("assistant", data.reply + " (ì¬ìƒì„±)");
  });
}

function save() {
  const blob = new Blob([JSON.stringify(history, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chat_history.json";
  a.click();
}

document.getElementById("fileUpload").addEventListener("change", function() {
  const file = this.files[0];
  if (!file) return;
  const form = new FormData();
  form.append("file", file);
  fetch("/upload", {method:"POST", body:form})
    .then(res => res.json())
    .then(data => {
      document.getElementById("uploadResult").value = data.content;
    });
});

document.getElementById("imageUpload").addEventListener("change", function() {
  const file = this.files[0];
  if (!file) return;
  const form = new FormData();
  form.append("file", file);
  fetch("/image", {method:"POST", body:form})
    .then(res => res.json())
    .then(data => {
      document.getElementById("imageResult").value = data.description;
    });
});

document.getElementById("voiceUpload").addEventListener("change", function() {
  const file = this.files[0];
  if (!file) return;
  const form = new FormData();
  form.append("file", file);
  fetch("/voice", {method:"POST", body:form})
    .then(res => res.json())
    .then(data => {
      document.getElementById("voiceResult").value = data.text;
    });
});

// ê´€ë¦¬ì ëª¨ë“œ ì „ì²´ ëŒ€í™” ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
function refreshAdmin() {
  if (!session_id || !is_admin) return;
  fetch(`/admin?session_id=${session_id}`)
    .then(res => res.json())
    .then(data => {
      const logDiv = document.getElementById("adminLog");
      logDiv.innerHTML = "";
      for (const [sid, sess] of Object.entries(data.all_sessions)) {
        logDiv.innerHTML += `<b>ìœ ì €:</b> ${sess.user} (ì„¸ì…˜ ID: ${sid})<br/>`;
        for (const msg of sess.history) {
          const roleIcon = msg.role === "user" ? "ğŸ‘¤" : "ğŸ¤–";
          logDiv.innerHTML += `${roleIcon} <i>${msg.role}</i>: ${msg.content}<br/>`;
        }
        logDiv.innerHTML += "<hr/>";
      }
    });
}

// ë‹¤í¬ëª¨ë“œ í† ê¸€ & ì €ì¥
function toggleTheme() {
  if (body.classList.contains("light")) {
    body.classList.replace("light", "dark");
    localStorage.setItem("theme", "dark");
    document.getElementById("themeToggle").innerText = "â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ ì „í™˜";
  } else {
    body.classList.replace("dark", "light");
    localStorage.setItem("theme", "light");
    document.getElementById("themeToggle").innerText = "ğŸŒ— ë‹¤í¬ëª¨ë“œ ì „í™˜";
  }
}

function loadTheme() {
  const saved = localStorage.getItem("theme") || "light";
  body.classList.remove("light", "dark");
  body.classList.add(saved);
  document.getElementById("themeToggle").innerText = saved === "light" ? "ğŸŒ— ë‹¤í¬ëª¨ë“œ ì „í™˜" : "â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ ì „í™˜";
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ í…Œë§ˆ ì ìš©
window.onload = () => {
  loadTheme();
};
</script>

</body>
</html>
