<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>GPT 챗봇 (파일·음성·이미지 입력)</title>
  <style>
    body { font-family: Arial; padding: 2em; background: #f5f5f5; }
    #login, #chat { max-width: 700px; margin: auto; background: white; padding: 2em; border-radius: 10px; }
    #chat { display: none; }
    #chatbox { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; background: #fefefe; }
    input, select, button, textarea { width: 100%; padding: 0.7em; margin-top: 0.5em; }
    .msg { margin: 0.5em 0; }
    .user { font-weight: bold; color: #007bff; }
    .bot { font-weight: bold; color: #28a745; }
  </style>
</head>
<body>

<div id="login">
  <h2>🔐 GPT 챗봇 로그인</h2>
  <input id="username" placeholder="사용자 이름" />
  <input id="password" type="password" placeholder="비밀번호 (기본: 12345678)" />
  <button onclick="login()">로그인</button>
  <p id="loginStatus" style="color:red;"></p>
</div>

<div id="chat">
  <h3>👤 <span id="displayName"></span>님, 환영합니다!</h3>
  <div id="chatbox"></div>
  <input id="message" placeholder="메시지를 입력하세요..." />
  <select id="model">
    <option value="gpt-4">GPT-4</option>
    <option value="gpt-3.5-turbo">GPT-3.5</option>
  </select>
  <button onclick="sendMessage()">보내기</button>
  <button onclick="regenerate()">↺ 다시 생성</button>
  <button onclick="save()">💾 저장</button>
  <hr />
  <h4>📁 파일 업로드 (PDF / TXT)</h4>
  <input type="file" id="fileUpload" accept=".pdf,.txt" />
  <textarea id="uploadResult" rows="4" readonly placeholder="요약 결과가 여기에 표시됩니다."></textarea>
  <hr />
  <h4>🖼️ 이미지 업로드 (설명)</h4>
  <input type="file" id="imageUpload" accept="image/*" />
  <textarea id="imageResult" rows="4" readonly placeholder="이미지 설명 결과가 여기에 표시됩니다."></textarea>
  <hr />
  <h4>🎤 음성 질문</h4>
  <input type="file" id="voiceUpload" accept="audio/*" />
  <textarea id="voiceResult" rows="2" readonly placeholder="음성 인식 결과가 여기에 표시됩니다."></textarea>
</div>

<script>
let session_id = "";
let history = [];

function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();

  fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
  .then(res => {
    if (!res.ok) throw new Error("Login failed");
    return res.json();
  })
  .then(data => {
    session_id = data.session_id;
    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
    document.getElementById("displayName").innerText = username;
  })
  .catch(() => {
    document.getElementById("loginStatus").innerText = "❌ 로그인 실패 (비밀번호 확인)";
  });
}

function appendMessage(role, content) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<span class="${role === 'user' ? 'user' : 'bot'}">${role === 'user' ? '👤 나' : '🤖 GPT'}:</span> ${content}`;
  document.getElementById("chatbox").appendChild(div);
  document.getElementById("chatbox").scrollTop = 99999;
}

function sendMessage() {
  const message = document.getElementById("message").value.trim();
  const model = document.getElementById("model").value;
  if (!message) return;

  appendMessage("user", message);
  document.getElementById("message").value = "";

  fetch('/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id, message, model })
  })
  .then(res => res.json())
  .then(data => {
    history = data.history;
    appendMessage("assistant", data.reply);
  });
}

function regenerate() {
  fetch('/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id, message: "[REPEAT_LAST]", model: document.getElementById("model").value })
  })
  .then(res => res.json())
  .then(data => {
    history = data.history;
    appendMessage("assistant", data.reply + " (재생성)");
  });
}

function save() {
  const blob = new Blob([JSON.stringify(history, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chat_history.json";
  a.click();
}

// 📁 파일 업로드
document.getElementById("fileUpload").addEventListener("change", function () {
  const file = this.files[0];
  const form = new FormData();
  form.append("file", file);
  fetch("/upload", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => {
      document.getElementById("uploadResult").value = data.content;
    });
});

// 🖼️ 이미지 업로드
document.getElementById("imageUpload").addEventListener("change", function () {
  const file = this.files[0];
  const form = new FormData();
  form.append("file", file);
  fetch("/image", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => {
      document.getElementById("imageResult").value = data.description;
    });
});

// 🎤 음성 업로드
document.getElementById("voiceUpload").addEventListener("change", function () {
  const file = this.files[0];
  const form = new FormData();
  form.append("file", file);
  fetch("/voice", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => {
      document.getElementById("voiceResult").value = data.text;
    });
});
</script>

</body>
</html>
