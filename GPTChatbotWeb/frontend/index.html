<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>GPT 챗봇</title>
  <style>
    body { font-family: Arial; padding: 2em; background: #f5f5f5; color: #000; }
    #chat { max-width: 700px; margin: auto; background: #fff; padding: 2em; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #chatbox { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; background: #fefefe; }
    input, select, button, textarea { width: 100%; padding: 0.7em; margin-top: 0.5em; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #007bff; color: #fff; font-weight: bold; cursor: pointer; }
    .msg { margin: 0.5em 0; white-space: pre-wrap; }
    .user { color: #007bff; font-weight: bold; }
    .bot { color: #28a745; font-weight: bold; }
  </style>
</head>
<body>

<div id="chat">
  <h2>🤖 GPT 챗봇</h2>
  <div id="chatbox"></div>
  <input id="message" placeholder="메시지를 입력하세요..." />
  <select id="model">
    <option value="gpt-4">GPT-4</option>
    <option value="gpt-3.5-turbo">GPT-3.5</option>
  </select>
  <button onclick="sendMessage()">보내기</button>
  <button onclick="regenerate()">↺ 다시 생성</button>
  <button onclick="save()">💾 저장</button>

  <hr />
  <h4>📁 파일 업로드 (PDF / TXT)</h4>
  <input type="file" id="fileUpload" accept=".pdf,.txt" />
  <textarea id="uploadResult" rows="4" readonly></textarea>

  <h4>🖼️ 이미지 업로드</h4>
  <input type="file" id="imageUpload" accept="image/*" />
  <textarea id="imageResult" rows="4" readonly></textarea>

  <h4>🎤 음성 질문</h4>
  <input type="file" id="voiceUpload" accept="audio/*" />
  <textarea id="voiceResult" rows="2" readonly></textarea>
</div>

<script>
let session_id = localStorage.getItem("session_id") || crypto.randomUUID();
localStorage.setItem("session_id", session_id);
let history = [];

function appendMessage(role, content) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<span class="${role === 'user' ? 'user' : 'bot'}">${role === 'user' ? '👤 나' : '🤖 GPT'}:</span> ${content}`;
  document.getElementById("chatbox").appendChild(div);
  document.getElementById("chatbox").scrollTop = 99999;
}

function sendMessage() {
  const message = document.getElementById("message").value.trim();
  const model = document.getElementById("model").value;
  if (!message) return;

  appendMessage("user", message);
  document.getElementById("message").value = "";

  fetch('/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id, message, model })
  })
  .then(res => res.json())
  .then(data => {
    history = data.history;
    appendMessage("assistant", data.reply);
  });
}

function regenerate() {
  fetch('/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id, message: "[REPEAT_LAST]", model: document.getElementById("model").value })
  })
  .then(res => res.json())
  .then(data => {
    history = data.history;
    appendMessage("assistant", data.reply + " (재생성)");
  });
}

function save() {
  const blob = new Blob([JSON.stringify(history, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chat_history.json";
  a.click();
}

document.getElementById("fileUpload").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;
  const form = new FormData();
  form.append("file", file);
  fetch("/upload", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => document.getElementById("uploadResult").value = data.content);
});

document.getElementById("imageUpload").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;
  const form = new FormData();
  form.append("file", file);
  fetch("/image", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => document.getElementById("imageResult").value = data.description);
});

document.getElementById("voiceUpload").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;
  const form = new FormData();
  form.append("file", file);
  fetch("/voice", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => document.getElementById("voiceResult").value = data.text);
});
</script>

</body>
</html>
